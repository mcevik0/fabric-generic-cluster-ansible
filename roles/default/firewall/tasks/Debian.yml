---
# roles/default/firewall/tasks/Debian.yml
# Firewall configuration for Debian using UFW

- name: Install UFW
  apt:
    name: ufw
    state: present
    update_cache: yes
  tags: firewall

- name: Set UFW default policies
  ufw:
    direction: "{{ item.direction }}"
    policy: "{{ item.policy }}"
  loop:
    - { direction: 'incoming', policy: 'deny' }
    - { direction: 'outgoing', policy: 'allow' }
    - { direction: 'routed', policy: 'deny' }
  tags: firewall

- name: Allow SSH (to prevent lockout)
  ufw:
    rule: allow
    port: '22'
    proto: tcp
  tags: firewall

- name: Allow services in UFW
  ufw:
    rule: allow
    name: "{{ item }}"
  loop: "{{ firewall_allowed_services }}"
  when: firewall_allowed_services is defined
  ignore_errors: yes  # Some service names might not be recognized by UFW
  tags: firewall

- name: Allow custom ports in UFW
  ufw:
    rule: allow
    port: "{{ item.port }}"
    proto: "{{ item.protocol | default('tcp') }}"
  loop: "{{ firewall_allowed_ports }}"
  when: firewall_allowed_ports is defined
  tags: firewall

- name: Allow traffic from trusted sources
  ufw:
    rule: allow
    from_ip: "{{ item }}"
  loop: "{{ firewall_trusted_sources }}"
  when: firewall_trusted_sources is defined
  tags: firewall

- name: Deny specific services (if specified)
  ufw:
    rule: deny
    name: "{{ item }}"
  loop: "{{ firewall_blocked_services | default([]) }}"
  when: firewall_blocked_services is defined
  ignore_errors: yes
  tags: firewall

- name: Enable UFW
  ufw:
    state: enabled
  tags: firewall

- name: Set UFW logging
  ufw:
    logging: "{{ firewall_logging_level | default('low') }}"
  tags: firewall
