# Prometheus configuration file
# Generated by Ansible

global:
  scrape_interval: {{ prometheus_scrape_interval }}
  evaluation_interval: {{ prometheus_evaluation_interval }}
{% if prometheus_external_labels %}
  external_labels:
{% for key, value in prometheus_external_labels.items() %}
    {{ key }}: {{ value }}
{% endfor %}
{% endif %}

{% if prometheus_enable_alerting and prometheus_alertmanager_url %}
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - {{ prometheus_alertmanager_url }}
{% endif %}

{% if prometheus_enable_alerting %}
rule_files:
  - "/etc/prometheus/rules/*.yml"
{% endif %}

scrape_configs:
  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          cluster: 'fabric-generic-cluster'
          role: 'monitoring'

  # Node Exporter - System metrics from all nodes
  - job_name: 'node_exporter'
    static_configs:
{% for host in groups['all_nodes'] | default([]) %}
      - targets: ['{{ hostvars[host]['ansible_default_ipv4']['address'] | default(hostvars[host]['ansible_host']) }}:9100']
        labels:
          instance: '{{ host }}'
          cluster: 'fabric-generic-cluster'
{% if host in groups.get('nodes_webserver', []) %}
          role: 'webserver'
{% elif host in groups.get('nodes_database', []) %}
          role: 'database'
{% elif host in groups.get('nodes_loadbalancer', []) %}
          role: 'loadbalancer'
{% else %}
          role: 'node'
{% endif %}
{% if 'site' in hostvars[host] %}
          site: '{{ hostvars[host]['site'] }}'
{% endif %}
{% endfor %}

  # cAdvisor - Docker container metrics from all nodes
  - job_name: 'cadvisor'
    static_configs:
{% for host in groups['all_nodes'] | default([]) %}
      - targets: ['{{ hostvars[host]['ansible_default_ipv4']['address'] | default(hostvars[host]['ansible_host']) }}:8080']
        labels:
          instance: '{{ host }}'
          cluster: 'fabric-generic-cluster'
{% if host in groups.get('nodes_webserver', []) %}
          role: 'webserver'
{% elif host in groups.get('nodes_database', []) %}
          role: 'database'
{% elif host in groups.get('nodes_loadbalancer', []) %}
          role: 'loadbalancer'
{% else %}
          role: 'node'
{% endif %}
{% if 'site' in hostvars[host] %}
          site: '{{ hostvars[host]['site'] }}'
{% endif %}
{% endfor %}
